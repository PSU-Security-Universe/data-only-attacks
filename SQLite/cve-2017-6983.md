# CVE-2017-6983

CVE-2017-6983 is a type confusion bug in SQLite that can provide arbitrary memory-write primitive. More details about this bug and its exploitation can be found via the following links

* [presentation](https://www.youtube.com/watch?v=Kqv8S1BQYwE&ab_channel=BlackHat)
* [slides p39-p60](https://www.blackhat.com/docs/us-17/wednesday/us-17-Feng-Many-Birds-One-Stone-Exploiting-A-Single-SQLite-Vulnerability-Across-Multiple-Software.pdf)

However, the bug is fixed in SQLite 3.40.1 and the `p->doXdgOpen` is not defined in old version. We manually insert the bug into new version.

```c
static int fts3FunctionArg(
  sqlite3_context *pContext,      /* SQL function call context */
  const char *zFunc,              /* Function name */
  sqlite3_value *pVal,            /* argv[0] passed to function */
  Fts3Cursor **ppCsr              /* OUT: Store cursor handle here */
){
  int rc;
  /* Insert Vuln */
+ Fts3Cursor *pRet;
+ memcpy(&pRet, sqlite3_value_blob(pVal), sizeof(Fts3Cursor *));
+ *ppCsr = pRet;
- *ppCsr = (Fts3Cursor*)sqlite3_value_pointer(pVal, "fts3cursor");
  if( (*ppCsr)!=0 ){
    rc = SQLITE_OK;
  }else{
    char *zErr = sqlite3_mprintf("illegal first argument to %s", zFunc);
    sqlite3_result_error(pContext, zErr, -1);
    sqlite3_free(zErr);
    rc = SQLITE_ERROR;
  }
  return rc;
}