# CVE-2021-30632 Explained

This is a JIT bug in the JavaScript Engine of Chrome, v8. In particular:

* During JIT optimization, v8 makes an incorrect assumption of the object map (layout).
* Therefore, the layout is modified while v8 assumes it is not.
* This issue leads to a type-confusion issue. 
* The type-confusion issue finally introduces arbitrary memory read and write.

More information about this bug is available [here](https://github.blog/security/vulnerability-research/chrome-in-the-wild-bug-analysis-cve-2021-30632/). The original PoC is available [here](https://github.com/github/securitylab/tree/main/SecurityExploits/Chrome/v8/CVE-2021-30632). Please check these files to obtain a comprehensive understanding of this bug.

To avoid loss of information, I create a [backup PDF](./cve-2021-30632-analysis.pdf) file for the original article by Man Yue Mo from GitHub Security Lab.

Next, I focus on discussing the steps to reproduce this bug, and reproduce the original PoC.

# Install Buggy V8

The bug was patched in 2021, so we have to obtain an old, vulnerable version. Following the PoC created by Man Yue Mo, we try to download the v8 version `9.3.345.16` (commit `632e6e7`).

I built v8 on Ubuntu 22.04 64bit. However, this version of Ubuntu uses python3.10 as the default python3, which has some compatible issues with the compilation scripts of v8. So I have to install python3.9 first.

## 1. Install python3.9 on Ubuntu 22.04

```bash
# Update package list and install prerequisites
sudo apt update
sudo apt install software-properties-common -y

# Add the Deadsnakes PPA (maintains older Python versions)
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update

# Install Python 3.9
sudo apt install python3.9 python3.9-venv python3.9-distutils -y

# Verify
python3.9 --version
```

> **Note**: Since Ubuntu 22.04 sets python3.10 as the default python3 version, it is possible that some programs assume python3.10. So we'd better not set python3.9 as the default version. We will specify the path to python3.9 for v8 build.

## 2. Build v8

```bash
# Install prerequisites for Ubuntu 22.04
sudo apt-get update
sudo apt-get install -y git curl python3 build-essential pkg-config ninja-build clang lld

# Get depot_tools and put it on PATH
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
export PATH="$PWD/depot_tools:$PATH"
echo 'export PATH="$PATH:'"$PWD"'/depot_tools"' >> ~/.bashrc
source ~/.bashrc  # or `source ~/.zshrc`

# Fetch v8
fetch v8
cd v8

# Check out the exact version
git fetch origin --tags --prune
git checkout 9.3.345.16
gclient sync -D --reset --with_branch_heads --with_tags

# Generate build files telling GN which Python to run actions with
gn gen out/x64.release --script-executable=/usr/bin/python3.9

# Build
tools/dev/gm.py x64.release

# Smoke test
out/x64.release/d8 -e "print(1+2)"
```

# Test the PoC

Download the poc by Man Yue Mo from [here][https://github.com/github/securitylab/blob/main/SecurityExploits/Chrome/v8/CVE-2021-30632/poc.js], or use our local copy [poc-by-mym.js](./poc-by-mym.js)

```bash
out/x64.release/d8 ./poc-by-mym.js
```

We can get a shell like

```bash
test-v8/v8/out/x64.release$ ./d8 poc-by-mym.js
instance: 81d42dd
elements: 804aba1
rwx page address: 3437bb5bd000
intArray addr: 8106d79
intBackingStore: 5d59854e6ef0
$ # <--- this is the new shell created by the exploit.
```